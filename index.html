<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Signal Card Reader — Leviathan V6</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #0a0a0f; color: #e0e0e0;
  font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
  padding: 16px; padding-top: max(16px, env(safe-area-inset-top));
  padding-bottom: max(16px, env(safe-area-inset-bottom));
  min-height: 100vh; min-height: -webkit-fill-available;
  -webkit-font-smoothing: antialiased;
  -webkit-text-size-adjust: 100%;
}
.mono { font-family: 'JetBrains Mono', monospace; }
.header { text-align: center; margin-bottom: 20px; }
.header h1 {
  font-size: 26px; font-weight: 700; letter-spacing: -1px;
  background: linear-gradient(135deg, #ff6b6b, #ffd700, #00ff87);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.header p { color: #555; font-size: 12px; margin-top: 4px; }

/* Input */
.input-area { margin-bottom: 20px; }
.input-area textarea {
  width: 100%; height: 70px; background: #12121a; border: 1px solid #222;
  border-radius: 8px; color: #e0e0e0; padding: 10px; font-size: 16px;
  font-family: 'JetBrains Mono', monospace; resize: none;
  -webkit-appearance: none; appearance: none;
}
.btn-row { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
.btn {
  border: none; font-weight: 700; padding: 8px 18px; border-radius: 6px;
  cursor: pointer; font-size: 13px; transition: opacity 0.2s;
  -webkit-tap-highlight-color: transparent; touch-action: manipulation;
}
.btn:active { opacity: 0.7; }
.btn-primary { background: linear-gradient(135deg, #ff6b6b, #ff9f43); color: #000; }
.btn-secondary { background: #1a1a2e; border: 1px solid #333; color: #888; }
.error { color: #ff4757; font-size: 12px; margin-top: 4px; }

/* Cards */
.card {
  background: #12121a; border: 1px solid #222; border-radius: 12px;
  padding: 16px; margin-bottom: 14px;
}
.card-gradient {
  background: linear-gradient(135deg, #12121a 0%, #1a1a2e 100%);
  border: 1px solid #222; border-radius: 12px; padding: 18px; margin-bottom: 14px;
}
.section-label {
  font-size: 11px; color: #666; text-transform: uppercase;
  letter-spacing: 1px; margin-bottom: 10px;
}

/* Pills */
.pill {
  display: inline-block; padding: 4px 12px; border-radius: 6px;
  font-size: 12px; font-weight: 700; margin: 2px 4px 2px 0;
}
.flag-pill {
  display: inline-block; padding: 3px 9px; border-radius: 4px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.5px; margin: 2px 3px 2px 0;
}

/* Stat boxes */
.stat-row { display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
.stat-box {
  flex: 1; min-width: 88px; background: #12121a; border: 1px solid #222;
  border-radius: 12px; padding: 14px 8px; text-align: center;
}
.stat-label { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
.stat-value { font-size: 28px; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
.stat-sub { font-size: 11px; margin-top: 4px; }

/* Pressure row */
.pressure-row { display: flex; flex-wrap: wrap; gap: 14px; }
.pressure-item { text-align: center; }
.pressure-label { font-size: 10px; color: #555; }
.pressure-value { font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

/* Platform bars */
.platform-row { display: flex; align-items: center; margin-bottom: 4px; }
.platform-name { width: 50px; color: #8a8a8a; font-size: 11px; text-transform: uppercase; font-weight: 600; }
.platform-track { flex: 1; height: 14px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden; }
.platform-fill { height: 100%; border-radius: 3px; }
.platform-val { width: 36px; text-align: right; font-size: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 600; margin-left: 6px; }
.platform-birth { width: 36px; text-align: right; font-size: 11px; font-family: 'JetBrains Mono', monospace; color: #555; margin-left: 4px; }
.platform-arrow { font-size: 10px; color: #444; margin: 0 2px; }
.platform-changes { font-size: 10px; color: #888; margin-left: 8px; font-family: 'JetBrains Mono', monospace; }

/* Module delta rows */
.mod-row { display: flex; align-items: center; gap: 6px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
.mod-name { width: 130px; font-size: 11px; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mod-track { flex: 1; height: 14px; background: #111; border-radius: 3px; position: relative; overflow: hidden; }
.mod-center { position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: #333; }
.mod-fill { position: absolute; top: 1px; bottom: 1px; border-radius: 2px; }
.mod-val { width: 52px; text-align: right; font-size: 11px; font-family: 'JetBrains Mono', monospace; font-weight: 600; }
.mod-rel { width: 28px; text-align: right; font-size: 10px; }

/* Simple module rows */
.simple-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.simple-label { color: #8a8a8a; font-size: 13px; min-width: 110px; }
.simple-val { font-size: 14px; font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #e0e0e0; }
.simple-delta { font-size: 12px; font-weight: 700; min-width: 60px; text-align: right; }

/* Timeline */
.timeline { position: relative; padding-left: 22px; }
.timeline-line { position: absolute; left: 6px; top: 0; bottom: 0; width: 2px; background: #222; }
.beat { display: flex; align-items: flex-start; margin-bottom: 7px; position: relative; }
.beat-dot { width: 13px; height: 13px; border-radius: 50%; position: absolute; left: -22px; top: 2px; border: 2px solid #0a0a0f; }
.beat-type { font-size: 11px; font-weight: 700; }
.beat-detail { font-size: 11px; color: #888; margin-left: 6px; }

/* Gate */
.gate-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
.gate-dot { width: 10px; height: 10px; border-radius: 50%; }
.gate-name { color: #8a8a8a; font-size: 12px; }
.gate-info { font-size: 12px; font-weight: 700; }

/* Net delta gauge */
.net-gauge {
  border-radius: 12px; padding: 20px; margin-bottom: 14px; text-align: center;
}
.net-value { font-size: 40px; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
.net-dir { font-size: 16px; font-weight: 700; margin-top: 4px; }
.net-stats { display: flex; justify-content: center; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
.net-stat-label { font-size: 10px; color: #555; }
.net-stat-val { font-size: 15px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: #e0e0e0; }

/* Verdict */
.verdict {
  border-radius: 12px; padding: 18px; margin-bottom: 14px; text-align: center;
  background: linear-gradient(135deg, #1a1a2e, #12121a);
}

/* Lattice */
.lattice-row { display: flex; gap: 12px; flex-wrap: wrap; }
.lattice-item { text-align: center; }
.lattice-key { font-size: 10px; color: #555; }
.lattice-val { font-size: 14px; font-weight: 700; color: #e0e0e0; font-family: 'JetBrains Mono', monospace; }

/* Zero modules */
.zero-mods { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); font-size: 10px; color: #444; }

/* Context pills */
.ctx-pills { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08); }
.ctx-pill { padding: 3px 8px; border-radius: 4px; font-size: 11px; border: 1px solid #33333344; }

/* Mismatch warning */
.mismatch {
  margin-top: 8px; padding: 4px 12px; background: #ff6b6b22; border-radius: 6px; display: inline-block;
}
.mismatch span { color: #ff6b6b; font-size: 12px; font-weight: 700; }

/* ── LINE RECALIBRATOR ── */
.recal-card {
  background: linear-gradient(135deg, #0f1a0f, #0a1a1a);
  border: 1px solid #1a3a2a;
  border-radius: 12px; padding: 16px; margin-bottom: 14px;
}
.recal-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;
}
.recal-title { font-size: 11px; color: #4ecdc4; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; }
.recal-input-row {
  display: flex; gap: 8px; align-items: center; margin-bottom: 14px; flex-wrap: wrap;
}
.recal-input {
  background: #0a0f0a; border: 1px solid #1a3a2a; border-radius: 8px;
  color: #00ff87; font-family: 'JetBrains Mono', monospace;
  font-size: 22px; font-weight: 700; width: 90px; padding: 8px 12px;
  text-align: center; -webkit-appearance: none; appearance: none;
  outline: none;
}
.recal-input:focus { border-color: #00ff87; box-shadow: 0 0 0 2px #00ff8722; }
.recal-btn {
  background: linear-gradient(135deg, #00ff87, #4ecdc4); color: #000;
  border: none; border-radius: 8px; font-weight: 700; font-size: 13px;
  padding: 10px 18px; cursor: pointer; touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.recal-btn:active { opacity: 0.7; }
.recal-birth-ref {
  font-size: 11px; color: #555; font-family: 'JetBrains Mono', monospace;
  padding: 6px 10px; background: #0f0f0f; border-radius: 6px; border: 1px solid #1a1a1a;
}
.recal-verdict-row {
  display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap;
}
.recal-box {
  flex: 1; min-width: 100px; border-radius: 10px; padding: 12px 8px;
  text-align: center; border: 1px solid #1a1a1a;
}
.recal-box-label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.recal-box-val { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
.recal-box-sub { font-size: 10px; margin-top: 3px; }
.recal-flip-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: #ff6b6b22; border: 1px solid #ff6b6b44;
  border-radius: 8px; padding: 6px 12px; margin-bottom: 12px;
}
.recal-flip-badge span { color: #ff6b6b; font-size: 12px; font-weight: 700; }
.recal-agree-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: #00ff8722; border: 1px solid #00ff8744;
  border-radius: 8px; padding: 6px 12px; margin-bottom: 12px;
}
.recal-agree-badge span { color: #00ff87; font-size: 12px; font-weight: 700; }
.recal-mod-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
}
.recal-mod-label { color: #666; font-size: 12px; }
.recal-mod-vals { display: flex; gap: 14px; align-items: center; }
.recal-mod-birth { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: #444; text-decoration: line-through; }
.recal-mod-new { font-size: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
.recal-mod-dir { font-size: 11px; font-weight: 700; min-width: 50px; text-align: right; }
.recal-divider { border: none; border-top: 1px solid #1a3a2a; margin: 10px 0; }
.recal-summary {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px; background: #0a0f0a; border-radius: 8px;
  border: 1px solid #1a3a2a; margin-top: 8px;
}
.recal-summary-label { font-size: 11px; color: #555; }
.recal-summary-val { font-size: 14px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.recal-overshoot {
  margin-top: 10px; padding: 8px 12px;
  background: #ffd70011; border: 1px solid #ffd70033;
  border-radius: 8px; font-size: 12px; color: #ffd700; font-weight: 600;
}
</style>
</head>
<body>

<div class="header">
  <h1>SIGNAL CARD READER</h1>
  <p>Leviathan V6 — Drop JSON, Read Signals</p>
</div>

<div class="input-area">
  <textarea id="jsonInput" placeholder="Paste signal card JSON here..."></textarea>
  <div class="btn-row">
    <button class="btn btn-primary" onclick="parseCard()">READ CARD</button>
    <label class="btn btn-primary" style="background:linear-gradient(135deg,#4ecdc4,#3498db);cursor:pointer;display:inline-block">
      UPLOAD FILE
      <input type="file" id="fileInput" accept=".json,application/json,text/plain,.txt" style="display:none" onchange="handleFile(this)">
    </label>
    <button class="btn btn-secondary" onclick="loadSample()">SAMPLE</button>
    <button class="btn btn-secondary" onclick="toggleRaw()">RAW</button>
  </div>
  <div id="error" class="error"></div>
  <div id="fileName" style="color:#4ecdc4;font-size:12px;margin-top:4px"></div>
</div>

<div id="dashboard"></div>

<script>
const SAMPLE = {"identity":{"player":"Lebron James","team":"LAL","stat":"REBS","date":"02-12-2026"},"locked_identity":{"opponent":"DAL","line":6.5},"state_snapshot":{"classification":{"velocity":"FAST","direction":"UP","magnitude":1.0,"confidence":0.75,"regime_tag":"REPRICE","signal_code":"REVERSE","reason_flags":[]},"stability":{"stability_state":"CONFIRMED","cycles_held":2,"flip_detected":false},"motion_context":{"birth_line":6.5,"current_line":7.5,"birth_delta":1.0,"cycle_delta":1.0},"line_movement_scoring":{"score":37.0,"bucket":"MEDIUM","direction":"UP"},"current_platforms":{"platforms":{"fd":6.5,"pp":6.5,"ud":6.5,"czr":6.5,"mgm":6.5,"kambi":6.0,"bovada":7.5,"rivers":6.5,"fanatics":6.5},"consensus_line":6.5},"birth_context":{"urdr_belief":{"chronicle_net_delta":-0.406,"chronicle_payload":{"modules":[{"code":"SEASON_BELOW","delta_logit_over":-0.1235,"reliability":0.5775,"data":{"season_avg":5.7,"line":6.5}},{"code":"L10_BELOW","delta_logit_over":-0.2154,"reliability":0.65,"data":{"l10_avg":5.1,"line":6.5}},{"code":"L5_BELOW","delta_logit_over":-0.3231,"reliability":0.55,"data":{"l5_avg":4.4,"line":6.5}},{"code":"VS_TEAM_ABOVE","delta_logit_over":0.2821,"reliability":0.45,"data":{"avg_vs_team":8.33,"games_vs":3,"opponent":"DAL"}},{"code":"CALIBRATION_UNDER","delta_logit_over":-0.0383,"reliability":0.1},{"code":"DEFENSE_AVERAGE","delta_logit_over":0.0,"reliability":0.85,"data":{"tier":"AVERAGE","defense_rank":13}},{"code":"PACE_NEUTRAL","delta_logit_over":0.011,"reliability":0.85},{"code":"REST_EXTENDED","delta_logit_over":0.05,"reliability":0.9,"data":{"is_b2b":false,"days_rest":3}},{"code":"VENUE_HOME","delta_logit_over":0.0158,"reliability":0.82,"data":{"is_home":true,"home_avg":6.0,"away_avg":5.5}},{"code":"GAME_ENV_COMFORTABLE","delta_logit_over":0.0375,"reliability":0.93,"data":{"environment":"COMFORTABLE","blowout_prob":0.25,"spread":-7.5,"player_role":"BENCH"}},{"code":"TEAMMATE_NO_DATA","delta_logit_over":0.0,"reliability":0.0},{"code":"LINE_STABLE","delta_logit_over":0.0,"reliability":0.7},{"code":"RECENT_FORM_COLD","delta_logit_over":-0.0646,"reliability":0.3},{"code":"EDGE_NEUTRAL","delta_logit_over":0.0,"reliability":0.3},{"code":"LINEUP_NO_DATA","delta_logit_over":0.0,"reliability":0.0}],"aggregate":{"avg_reliability":0.5232,"non_zero_modules":10,"net_delta_logit_over":-0.3685,"weighted_delta_logit_over":-0.1831}}}},"matchup_context":{"is_b2b":false,"l5_avg":4.4,"is_home":true,"away_avg":5.5,"home_avg":6.0,"games_vs":3,"opponent":"DAL","season_avg":5.7,"avg_vs_team":8.33,"l10_avg":5.1,"defense_rank":13,"defense_tier":"AVERAGE","expected_pace":99.5,"game_environment":{"total":237.5,"spread":-7.5,"environment":"COMFORTABLE","player_role":"BENCH","blowout_prob":0.25},"recent_form":{"cv":0.341,"trend":0,"avg_l5":4.4,"edge_pct":-0.3231,"games_l5":5},"all_modules":{"SEASON_AVG":{"season_avg":5.7,"line":6.5},"L10_AVG":{"l10_avg":5.1,"line":6.5},"L5_AVG":{"l5_avg":4.4,"line":6.5},"PLAYER_VS_TEAM":{"avg_vs_team":8.33,"games_vs":3,"opponent":"DAL"},"DEFENSE":{"tier":"AVERAGE","defense_rank":13},"PACE":{"pace_diff":-0.05,"expected_pace":99.5},"REST":{"is_b2b":false,"days_rest":3},"HOME_AWAY":{"is_home":true,"home_avg":6.0,"away_avg":5.5},"GAME_ENVIRONMENT":{"environment":"COMFORTABLE","blowout_prob":0.25,"spread":-7.5,"player_role":"BENCH"},"RECENT_FORM":{"avg_l5":4.4,"games_l5":5,"edge_pct":-0.3231}}},"projection_direction":"UNDER","lattice":{"STORM":"SINGLE_BOOK","ASGARD":"CH1","MJOLNIR":"BOOKS","THUNDER":0.65},"decision_context":{"signal_code":"REVERSE","direction":"OVER","relationship":"FADE","regime_tag":"REPRICE","line":7.5,"regime_basis":{"moneyline_delta":0,"total_delta":3.0,"spread_delta":0}},"verdict_payload":{"tier":"CONDITIONAL","line":6.5,"quality":{"gate_a":{"gate":"A_EDGE","passed":true,"edge_pct":21.8},"gate_b":{"gate":"B_TRAP","passed":false,"trap_codes":["FADE_UNRESOLVED"]},"gate_c":{"gate":"C_CONFIDENCE","composite":0.37,"confidence":"GOOD","factors_aligned":2}},"birth_context":{"urdr_belief":{"chronicle_net_delta":-0.406,"chronicle_payload":{"modules":[{"code":"SEASON_BELOW","delta_logit_over":-0.1235,"reliability":0.5775},{"code":"L10_BELOW","delta_logit_over":-0.2154,"reliability":0.65},{"code":"L5_BELOW","delta_logit_over":-0.3231,"reliability":0.55},{"code":"VS_TEAM_ABOVE","delta_logit_over":0.2821,"reliability":0.45},{"code":"CALIBRATION_UNDER","delta_logit_over":-0.0383,"reliability":0.1},{"code":"DEFENSE_AVERAGE","delta_logit_over":0.0,"reliability":0.85},{"code":"PACE_NEUTRAL","delta_logit_over":0.011,"reliability":0.85},{"code":"REST_EXTENDED","delta_logit_over":0.05,"reliability":0.9},{"code":"VENUE_HOME","delta_logit_over":0.0158,"reliability":0.82},{"code":"GAME_ENV_COMFORTABLE","delta_logit_over":0.0375,"reliability":0.93},{"code":"TEAMMATE_NO_DATA","delta_logit_over":0.0,"reliability":0.0},{"code":"LINE_STABLE","delta_logit_over":0.0,"reliability":0.7},{"code":"RECENT_FORM_COLD","delta_logit_over":-0.0646,"reliability":0.3},{"code":"EDGE_NEUTRAL","delta_logit_over":0.0,"reliability":0.3},{"code":"LINEUP_NO_DATA","delta_logit_over":0.0,"reliability":0.0}],"aggregate":{"avg_reliability":0.5232,"non_zero_modules":10,"net_delta_logit_over":-0.3685,"weighted_delta_logit_over":-0.1831}}}}},"loom_story":{"headline":"Lineup NEW_STARTER, TOTAL +3.0, Engine REVERSE","beats":[{"beat_type":"LINEUP_CHANGE","facts":{"player_name":"LeBron James","change_type":"NEW_STARTER"}},{"beat_type":"LINEUP_CHANGE","facts":{"player_name":"Austin Reaves","change_type":"NEW_STARTER"}},{"beat_type":"LINEUP_CHANGE","facts":{"player_name":"Marcus Smart","change_type":"NEW_STARTER"}},{"beat_type":"LINEUP_CHANGE","facts":{"player_name":"Jake LaRavia","change_type":"NEW_STARTER"}},{"beat_type":"LINE_MOVE","facts":{"snapshot_type":"SPREAD","previous_value":"-7.5","value":-6.5,"delta":1.0}},{"beat_type":"LINE_MOVE","facts":{"snapshot_type":"TOTAL","previous_value":"235.5","value":236.5,"delta":1.0}},{"beat_type":"LINE_MOVE","facts":{"snapshot_type":"MONEYLINE","previous_value":"-310","value":-285,"delta":25}},{"beat_type":"LINE_MOVE","facts":{"snapshot_type":"TOTAL","previous_value":"236.5","value":235.5,"delta":-1.0}},{"beat_type":"LINE_MOVE","facts":{"snapshot_type":"MONEYLINE","previous_value":"-285","value":-270,"delta":15}}]}},"confidence_breakdown":{"model_confidence":0.75,"stability_state":"CONFIRMED"},"action_tier_hint":"MONITOR_ONLY"};

const STAT_NAMES = {pts:"Points",asts:"Assists",rebs:"Rebounds",ra:"Reb+Ast",pa:"Pts+Ast",pra:"Pts+Reb+Ast",REBS:"Rebounds",PTS:"Points",ASTS:"Assists",RA:"Reb+Ast",PA:"Pts+Ast",PRA:"Pts+Reb+Ast"};

let currentCard = SAMPLE;
let showRaw = false;
let recalLine = null;

function loadSample() {
  document.getElementById('jsonInput').value = '';
  document.getElementById('error').textContent = '';
  document.getElementById('fileName').textContent = '';
  currentCard = SAMPLE;
  recalLine = null;
  render();
}

function handleFile(input) {
  const file = input.files[0];
  if (!file) return;
  document.getElementById('fileName').textContent = 'Loading: ' + file.name;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      var text = e.target.result;
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      currentCard = JSON.parse(text);
      recalLine = null;
      document.getElementById('error').textContent = '';
      document.getElementById('fileName').textContent = 'Loaded: ' + file.name;
      document.getElementById('jsonInput').value = '';
      render();
    } catch(err) {
      document.getElementById('error').textContent = 'Error: ' + err.message;
      document.getElementById('fileName').textContent = '';
    }
  };
  reader.onerror = function() {
    document.getElementById('error').textContent = 'Could not read file';
  };
  reader.readAsText(file, 'UTF-8');
  input.value = '';
}

function parseCard() {
  const input = document.getElementById('jsonInput').value.trim();
  if (!input) { document.getElementById('error').textContent = 'Paste JSON first'; return; }
  try {
    currentCard = JSON.parse(input);
    recalLine = null;
    document.getElementById('error').textContent = '';
    try { render(); } catch(re) { document.getElementById('error').textContent = 'Render error: ' + re.message; console.error(re); }
  } catch(e) {
    document.getElementById('error').textContent = 'Invalid JSON — check your paste';
  }
}

function toggleRaw() { showRaw = !showRaw; render(); }

function applyRecal() {
  const val = parseFloat(document.getElementById('recalInput').value);
  if (isNaN(val) || val <= 0) return;
  recalLine = val;
  render();
  // scroll to recal section
  setTimeout(() => {
    const el = document.getElementById('recalSection');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function clearRecal() {
  recalLine = null;
  render();
}

function c(confidence) { return confidence >= 0.7 ? '#00ff87' : confidence >= 0.5 ? '#ffd700' : '#ff4757'; }
function regimeC(r) { return {REPRICE:'#ffd700',OVERSHOOT:'#ff6b6b',STABLE:'#4ecdc4',BREAKOUT:'#00ff87',DRIFT:'#a0a0a0'}[r]||'#a0a0a0'; }
function sigC(s) { return {REVERSE:'#ff6b6b',SNAPBACK:'#ffd700',CONFIRM:'#00ff87',FADE:'#ff9f43',DRIFT:'#a0a0a0'}[s]||'#a0a0a0'; }
function bucketC(b) { return {HIGH:'#00ff87',MEDIUM:'#ffd700',LOW:'#ff4757'}[b]||'#a0a0a0'; }
function flagC(f) { return {STEAM:'#ff6b6b',SHARP_CONSENSUS:'#ff9f43',CROSSBOOK:'#ffd700',FOLLOW:'#4ecdc4',TENSION:'#ff4757',STALE_LINE:'#a0a0a0',REVERSE:'#ff6b6b',DRIFT:'#a0a0a0',FIRST_BOVADA:'#3498db',FIRST_PP:'#3498db',FIRST_FD:'#3498db',FIRST_DK:'#3498db',ASYM:'#9b59b6',MAG_FADE:'#e74c3c',PP_STALE:'#a0a0a0',TOTAL_MOVE_UP:'#00ff87',TOTAL_MOVE_DOWN:'#ff4757',TOTAL_ALIGNED_PROP:'#ffd700'}[f]||'#555'; }
function beatC(b) { return {LINEUP_CHANGE:'#4ecdc4',LINE_MOVE:'#ffd700',ENGINE_STATE:'#ff6b6b',OPERATOR_STATE:'#9b59b6'}[b]||'#555'; }
function hitC(hr) {
  if (hr == null || isNaN(hr)) return '#888';
  return hr >= 55 ? '#00ff87' : hr >= 48 ? '#ffd700' : '#ff4757';
}

// ── RECALIBRATOR LOGIC ──
// Extract the key stat values from the card for recalibration
function extractRecalStats(d) {
  const ss = d.state_snapshot || {};
  const mc = ss.matchup_context || {};
  const modules = mc.all_modules || {};
  const li = d.locked_identity || {};
  const mot = ss.motion_context || {};
  const dc = ss.decision_context || {};
  const vp = ss.verdict_payload || {};
  const birthLine = mot.birth_line || vp.line || dc.line || li.line || 0;
  const currentLine = mot.current_line || li.line || dc.line || 0;

  const stats = [];

  if (modules.SEASON_AVG && modules.SEASON_AVG.season_avg != null)
    stats.push({ label: 'Season Avg', key: 'SEASON_AVG', value: modules.SEASON_AVG.season_avg, reliability: 0.7 });
  if (modules.L10_AVG && modules.L10_AVG.l10_avg != null)
    stats.push({ label: 'L10 Avg', key: 'L10_AVG', value: modules.L10_AVG.l10_avg, reliability: 0.65 });
  if (modules.L5_AVG && modules.L5_AVG.l5_avg != null)
    stats.push({ label: 'L5 Avg', key: 'L5_AVG', value: modules.L5_AVG.l5_avg, reliability: 0.55 });
  if (modules.PLAYER_VS_TEAM && modules.PLAYER_VS_TEAM.avg_vs_team != null)
    stats.push({ label: `vs ${modules.PLAYER_VS_TEAM.opponent||'OPP'} (${modules.PLAYER_VS_TEAM.games_vs||'?'}g)`, key: 'PLAYER_VS_TEAM', value: modules.PLAYER_VS_TEAM.avg_vs_team, reliability: 0.1, note: 'low n' });
  if (modules.HOME_AWAY) {
    const isHome = mc.is_home;
    const avg = isHome ? modules.HOME_AWAY.home_avg : modules.HOME_AWAY.away_avg;
    if (avg != null)
      stats.push({ label: isHome ? 'Home Avg' : 'Away Avg', key: 'HOME_AWAY', value: avg, reliability: 0.85 });
  }

  // Also pull from urdr modules for calibration/recent form values
  const urdr = (ss.birth_context && ss.birth_context.urdr_belief) ||
               (vp && vp.birth_context && vp.birth_context.urdr_belief) || {};
  const urdrMods = (urdr.chronicle_payload && urdr.chronicle_payload.modules) || [];

  const recentFormMod = urdrMods.find(m => m.code && m.code.startsWith('RECENT_FORM') && m.data && m.data.avg_l5 != null);
  if (recentFormMod && recentFormMod.data.avg_l5 != null && !stats.find(s => s.key === 'L5_AVG'))
    stats.push({ label: 'L5 (Form)', key: 'L5_FORM', value: recentFormMod.data.avg_l5, reliability: 0.33 });

  return { stats, birthLine, currentLine };
}

function renderRecalibrator(d, birthLine, currentLine, stats) {
  const newLine = recalLine;

  // summary counts at birth line vs new line
  const birthOver = stats.filter(s => s.value > birthLine).length;
  const birthUnder = stats.filter(s => s.value < birthLine).length;
  const newOver = stats.filter(s => s.value > newLine).length;
  const newUnder = stats.filter(s => s.value < newLine).length;

  const birthVerdict = birthOver > birthUnder ? 'OVER' : birthUnder > birthOver ? 'UNDER' : 'SPLIT';
  const newVerdict = newOver > newUnder ? 'OVER' : newUnder > newOver ? 'UNDER' : 'SPLIT';
  const flipped = birthVerdict !== 'SPLIT' && newVerdict !== 'SPLIT' && birthVerdict !== newVerdict;
  const agreed = birthVerdict === newVerdict && birthVerdict !== 'SPLIT';

  const birthVColor = birthVerdict === 'OVER' ? '#00ff87' : birthVerdict === 'UNDER' ? '#ff4757' : '#ffd700';
  const newVColor = newVerdict === 'OVER' ? '#00ff87' : newVerdict === 'UNDER' ? '#ff4757' : '#ffd700';

  // weighted net delta at new line (simplified: sum of reliability * sign(value - newLine))
  let weightedNet = 0;
  let totalRel = 0;
  stats.forEach(s => {
    if (s.value !== newLine) {
      const sign = s.value > newLine ? 1 : -1;
      weightedNet += sign * s.reliability;
      totalRel += s.reliability;
    }
  });
  const normalizedNet = totalRel > 0 ? (weightedNet / totalRel) : 0;
  const netColor = normalizedNet > 0 ? '#00ff87' : normalizedNet < 0 ? '#ff4757' : '#888';
  const netVerdict = normalizedNet > 0.15 ? 'OVER' : normalizedNet < -0.15 ? 'UNDER' : 'LEAN';

  // market direction
  const ss = d.state_snapshot || {};
  const cl = ss.classification || {};
  const marketDir = cl.direction || '—';
  const mktColor = marketDir === 'UP' ? '#00ff87' : marketDir === 'DOWN' ? '#ff4757' : '#888';

  // overshoot detection: market moved line DOWN but stats say OVER at new line
  const overshoot = marketDir === 'DOWN' && newVerdict === 'OVER';
  const undershoot = marketDir === 'UP' && newVerdict === 'UNDER';

  let html = `<div class="recal-card" id="recalSection">
    <div class="recal-header">
      <div class="recal-title">⚗ Line Recalibrator</div>
      <button onclick="clearRecal()" style="background:none;border:1px solid #1a3a2a;border-radius:6px;color:#555;font-size:11px;padding:4px 10px;cursor:pointer">CLEAR</button>
    </div>`;

  // flip / agree badge
  if (flipped) {
    html += `<div class="recal-flip-badge"><span>⚠ VERDICT FLIPPED — Born ${birthVerdict} @ ${birthLine}, Now ${newVerdict} @ ${newLine}</span></div><br>`;
  } else if (agreed) {
    html += `<div class="recal-agree-badge"><span>✓ VERDICT CONSISTENT — ${newVerdict} at both ${birthLine} and ${newLine}</span></div><br>`;
  }

  // three boxes: birth verdict | new verdict | weighted signal
  html += `<div class="recal-verdict-row">
    <div class="recal-box" style="background:#0a0a0a;border-color:#222">
      <div class="recal-box-label">Birth @ ${birthLine}</div>
      <div class="recal-box-val" style="color:${birthVColor}">${birthVerdict}</div>
      <div class="recal-box-sub" style="color:#555">${birthOver}↑ ${birthUnder}↓</div>
    </div>
    <div class="recal-box" style="background:#0a1a0a;border-color:#1a3a2a">
      <div class="recal-box-label">New @ ${newLine}</div>
      <div class="recal-box-val" style="color:${newVColor}">${newVerdict}</div>
      <div class="recal-box-sub" style="color:#555">${newOver}↑ ${newUnder}↓</div>
    </div>
    <div class="recal-box" style="background:#0a0a0a;border-color:#222">
      <div class="recal-box-label">Wtd Signal</div>
      <div class="recal-box-val" style="color:${netColor}">${normalizedNet > 0 ? '+' : ''}${normalizedNet.toFixed(2)}</div>
      <div class="recal-box-sub" style="color:${netColor}">${netVerdict}</div>
    </div>
    <div class="recal-box" style="background:#0a0a0a;border-color:#222">
      <div class="recal-box-label">Market</div>
      <div class="recal-box-val" style="color:${mktColor}">${marketDir}</div>
      <div class="recal-box-sub" style="color:#555">${birthLine} → ${currentLine}</div>
    </div>
  </div>`;

  // overshoot / undershoot warning
  if (overshoot) {
    html += `<div class="recal-overshoot">⚡ POSSIBLE OVERSHOOT — Market pushed line DOWN but stats say OVER at ${newLine}. Fade opportunity?</div>`;
  } else if (undershoot) {
    html += `<div class="recal-overshoot" style="background:#ff475711;border-color:#ff475733;color:#ff6b6b">⚡ POSSIBLE UNDERSHOOT — Market pushed line UP but stats say UNDER at ${newLine}.</div>`;
  }

  // module breakdown at new line
  html += `<hr class="recal-divider">
    <div style="font-size:10px;color:#555;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Module vs New Line (${newLine})</div>`;

  stats.forEach(s => {
    const birthDelta = s.value - birthLine;
    const newDelta = s.value - newLine;
    const birthDir = birthDelta > 0 ? 'OVER' : birthDelta < 0 ? 'UNDER' : 'PUSH';
    const newDir = newDelta > 0 ? 'OVER' : newDelta < 0 ? 'UNDER' : 'PUSH';
    const birthDColor = birthDir === 'OVER' ? '#3a5a3a' : birthDir === 'UNDER' ? '#5a3a3a' : '#444';
    const newDColor = newDir === 'OVER' ? '#00ff87' : newDir === 'UNDER' ? '#ff4757' : '#888';
    const changed = birthDir !== newDir;

    html += `<div class="recal-mod-row">
      <span class="recal-mod-label">${s.label}${s.note ? ` <span style="color:#555;font-size:10px">(${s.note})</span>` : ''}</span>
      <div class="recal-mod-vals">
        <span class="recal-mod-birth" style="color:${birthDColor}">${birthDelta > 0 ? '+' : ''}${birthDelta.toFixed(1)} ${birthDir}</span>
        <span style="color:#333;font-size:10px">→</span>
        <span class="recal-mod-new" style="color:${newDColor}">${newDelta > 0 ? '+' : ''}${newDelta.toFixed(1)}</span>
        <span class="recal-mod-dir" style="color:${newDColor}">${newDir}${changed ? ' <span style="color:#ffd700;font-size:10px">↺</span>' : ''}</span>
      </div>
    </div>`;
  });

  // summary bar
  html += `<div class="recal-summary">
    <div>
      <div class="recal-summary-label">Combined read @ ${newLine}</div>
      <div class="recal-summary-val" style="color:${newVColor}">${newOver} OVER · ${newUnder} UNDER · ${newVerdict}</div>
    </div>
    <div style="text-align:right">
      <div class="recal-summary-label">Weighted net</div>
      <div class="recal-summary-val" style="color:${netColor}">${normalizedNet > 0 ? '+' : ''}${normalizedNet.toFixed(3)}</div>
    </div>
  </div>`;

  html += `</div>`;
  return html;
}

function render() {
  try {
    const d = currentCard;
    const id = d.identity || d.locked_identity || {};
    const li = d.locked_identity || {};
    const ss = d.state_snapshot || {};
    const cl = ss.classification || {};
    const mc = ss.matchup_context || {};
    const lms = ss.line_movement_scoring || {};
    const mot = ss.motion_context || {};
    const plat = ss.current_platforms || {};
    const stab = ss.stability || {};
    const dc = ss.decision_context || {};
    const vp = ss.verdict_payload || {};
    const qual = vp.quality || {};
    const lat = ss.lattice || {};
    const conf = d.confidence_breakdown || {};
    const flags = cl.signal_flags || cl.reason_flags || [];
    const rb = cl.regime_basis || dc.regime_basis || {};
    const contextFlags = (rb && rb.context_flags) || [];
    const line = li.line || dc.line || vp.line || mot.current_line || 0;
    const modules = mc.all_modules || {};
    const urdr = (ss.birth_context && ss.birth_context.urdr_belief) || (vp && vp.birth_context && vp.birth_context.urdr_belief) || {};
    const cp = urdr.chronicle_payload || {};
    const urdrMods = cp.modules || [];
    const agg = cp.aggregate || {};
    const netDelta = agg.net_delta_logit_over ?? urdr.chronicle_net_delta ?? null;
    const weightedDelta = agg.weighted_delta_logit_over ?? 0;
    const activeMods = urdrMods.filter(m => m.delta_logit_over !== 0);
    const zeroMods = urdrMods.filter(m => m.delta_logit_over === 0);
    const projDir = ss.projection_direction;
    const ge = mc.game_environment || {};
    const rf = mc.recent_form || {};
    const loom = ss.loom_story || {};
    const beats = loom.beats || [];
    const bc = ss.birth_context || {};
    const birthPlats = bc.platforms || {};

    // EDGE QUALITY extraction
    const edgeMod =
      urdrMods.find(m => m.module_code === 'EDGE_QUALITY') ||
      urdrMods.find(m => (m.code || '').includes('EDGE') && m.data && (m.data.hit_rate != null || m.data.edge_bucket));
    const edgeData = (edgeMod && edgeMod.data) ? edgeMod.data : null;
    const edgeHit = edgeData && edgeData.hit_rate != null ? Number(edgeData.hit_rate) : null;
    const edgeN   = edgeData && edgeData.sample_size != null ? Number(edgeData.sample_size) : null;
    const edgeBucket = edgeData && edgeData.edge_bucket ? String(edgeData.edge_bucket) : null;
    const edgePct = edgeData && edgeData.edge_pct != null ? Number(edgeData.edge_pct) : null;
    const edgeHook = edgeData && edgeData.hook_line != null ? !!edgeData.hook_line : null;
    const edgeCode = edgeMod && edgeMod.code ? String(edgeMod.code) : null;

    // Module vs line deltas
    const modDeltas = [];
    if (modules.SEASON_AVG) modDeltas.push({label:'Season Avg', value:modules.SEASON_AVG.season_avg, line});
    if (modules.L10_AVG) modDeltas.push({label:'L10 Avg', value:modules.L10_AVG.l10_avg, line});
    if (modules.L5_AVG) modDeltas.push({label:'L5 Avg', value:modules.L5_AVG.l5_avg, line});
    if (modules.PLAYER_VS_TEAM) modDeltas.push({label:`vs ${modules.PLAYER_VS_TEAM.opponent} (${modules.PLAYER_VS_TEAM.games_vs}g)`, value:modules.PLAYER_VS_TEAM.avg_vs_team, line});
    if (modules.HOME_AWAY) modDeltas.push({label:mc.is_home?'Home Avg':'Away Avg', value:mc.is_home?modules.HOME_AWAY.home_avg:modules.HOME_AWAY.away_avg, line});
    const overCount = modDeltas.filter(m=>m.value>line).length;
    const underCount = modDeltas.filter(m=>m.value<line).length;

    const formMod = urdrMods.find(m => m.code && m.code.startsWith('RECENT_FORM'));
    const formCode = formMod ? formMod.code.replace('RECENT_FORM_','') : null;

    // Extract recal stats
    const { stats: recalStats, birthLine, currentLine } = extractRecalStats(d);

    let html = '';

    // PLAYER HEADER
    const dirColor = projDir === 'OVER' ? '#00ff87' : projDir === 'UNDER' ? '#ff4757' : '#888';
    const mktColor = cl.direction === 'UP' ? '#00ff87' : '#ff4757';

    html += `<div class="card-gradient">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <h2 style="font-size:22px;font-weight:700;color:#fff">${id.player||'Unknown'}</h2>
          <p style="color:#888;font-size:13px;margin-top:3px">${id.team||''} vs ${li.opponent||mc.opponent||'—'} · ${STAT_NAMES[id.stat]||id.stat||''} · ${id.date||''}</p>
        </div>
        <div style="text-align:right">
          <div class="mono" style="font-size:34px;font-weight:700;color:#fff">${line}</div>
          <div style="font-size:11px;color:#888">LINE</div>
        </div>
      </div>
      <div style="display:flex;gap:6px;margin-top:14px;flex-wrap:wrap">
        <span class="pill" style="background:${dirColor}22;color:${dirColor};border:1px solid ${dirColor}44">MODEL: ${projDir||'—'}</span>
        <span class="pill" style="background:${mktColor}22;color:${mktColor};border:1px solid ${mktColor}44">MARKET: ${cl.direction||'—'}</span>
        <span class="pill" style="background:${sigC(cl.signal_code)}22;color:${sigC(cl.signal_code)};border:1px solid ${sigC(cl.signal_code)}44">${cl.signal_code||'—'}</span>
        <span class="pill" style="background:#ffd70022;color:#ffd700;border:1px solid #ffd70044">${vp.tier||d.action_tier_hint||'—'}</span>
      </div>
    </div>`;

    // MARKET SIGNALS
    html += `<div class="card" style="border:1px solid #333;background:linear-gradient(135deg,#0f0f1a,#151520)">
      <div class="section-label" style="color:#888;font-size:12px;letter-spacing:2px;margin-bottom:12px">⚡ MARKET SIGNALS</div>`;

    html += `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">`;
    if (flags.length > 0) {
      flags.forEach(f => {
        html += `<span class="flag-pill" style="background:${flagC(f)}22;color:${flagC(f)};border:1px solid ${flagC(f)}55;font-size:12px;padding:5px 12px">${f}</span>`;
      });
    } else {
      html += `<span style="color:#555;font-size:11px;font-style:italic">No signal flags</span>`;
    }
    html += `</div>`;

    if (contextFlags.length > 0) {
      html += `<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px">`;
      contextFlags.forEach(f => {
        html += `<span class="flag-pill" style="background:#9b59b622;color:#9b59b6;border:1px solid #9b59b644;font-size:11px;padding:3px 10px">${f}</span>`;
      });
      html += `</div>`;
    }

    if (edgeData) {
      const hrColor = hitC(edgeHit);
      const edgeLabelColor = edgeCode === 'EDGE_DEATH' ? '#ff4757' : '#ffd700';
      const edgeLabelBg = edgeCode === 'EDGE_DEATH' ? '#ff475722' : '#ffd70022';
      html += `<div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-size:12px;color:#888">
          Edge Quality:
          <strong class="mono" style="color:${hrColor}">${edgeHit!=null?edgeHit.toFixed(0)+'%':'—'}</strong>
          <span style="color:#555">${edgeN!=null?'(n='+edgeN+')':''}</span>
          <span style="color:#777">${edgeBucket?(' • bucket '+edgeBucket):''}</span>
          <span style="color:#777">${(edgePct!=null)?(' • edge '+edgePct.toFixed(1)+'%'):''}</span>
          <span style="color:#777">${edgeHook===true?' • hook':''}</span>
        </div>
        <span class="pill" style="font-size:11px;padding:3px 10px;background:${edgeLabelBg};color:${edgeLabelColor};border:1px solid ${edgeLabelColor}44">
          ${edgeCode || 'EDGE_QUALITY'}
        </span>
      </div>`;
    }

    html += `<div style="padding-top:8px;border-top:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:12px;color:#888">Market says <strong style="color:${mktColor}">${cl.direction||'—'}</strong> · Model says <strong style="color:${dirColor}">${projDir||'—'}</strong></div>
      <span class="pill" style="font-size:11px;padding:3px 10px;background:${dc.relationship==='FADE'?'#ff9f4322':dc.relationship==='CONFIRM'?'#00ff8722':'#55555522'};color:${dc.relationship==='FADE'?'#ff9f43':dc.relationship==='CONFIRM'?'#00ff87':'#888'};border:1px solid ${dc.relationship==='FADE'?'#ff9f4344':dc.relationship==='CONFIRM'?'#00ff8744':'#55555544'}">${dc.relationship||'—'}</span>
    </div>`;
    html += `</div>`;

    // STAT BOXES
    const confVal = conf.model_confidence || cl.confidence || 0;
    const bdColor = (mot.birth_delta||0) > 0 ? '#00ff87' : (mot.birth_delta||0) < 0 ? '#ff4757' : '#888';
    const hrColor = hitC(edgeHit);
    const edgeSub = edgeData ? `${edgeBucket ? edgeBucket : '—'}${edgeN!=null ? ' • n=' + edgeN : ''}` : 'no data';

    html += `<div class="stat-row">
      <div class="stat-box">
        <div class="stat-label">Confidence</div>
        <div class="stat-value" style="color:${c(confVal)}">${(confVal*100).toFixed(0)}%</div>
        <div class="stat-sub" style="color:#555">${stab.stability_state||'—'}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Regime</div>
        <div style="font-size:22px;font-weight:700;color:${regimeC(cl.regime_tag)}">${cl.regime_tag||'—'}</div>
        <div class="stat-sub" style="color:${sigC(dc.relationship)};font-weight:700">${dc.relationship||'—'}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">LM Score</div>
        <div class="stat-value" style="color:${bucketC(lms.bucket)}">${(lms.score||0).toFixed(1)}</div>
        <div class="stat-sub" style="color:${bucketC(lms.bucket)}">${lms.bucket||'—'}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Birth Δ</div>
        <div class="stat-value" style="color:${bdColor}">${(mot.birth_delta||0)>0?'+':''}${mot.birth_delta||0}</div>
        <div class="stat-sub" style="color:#555">${cl.velocity||'—'}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Edge Quality</div>
        <div class="stat-value" style="color:${hrColor}">${edgeHit!=null ? edgeHit.toFixed(0)+'%' : '—'}</div>
        <div class="stat-sub" style="color:${edgeCode==='EDGE_DEATH'?'#ff4757':'#555'}">${edgeSub}</div>
      </div>
    </div>`;

    // GAME PRESSURE
    let pressureItems = '';
    if (rb.moneyline_delta) pressureItems += `<div class="pressure-item"><div class="pressure-label">ML DELTA</div><div class="pressure-value" style="color:${rb.moneyline_delta<0?'#ff9f43':'#4ecdc4'}">${rb.moneyline_delta>0?'+':''}${rb.moneyline_delta}</div></div>`;
    if (rb.total_delta) pressureItems += `<div class="pressure-item"><div class="pressure-label">TOTAL Δ</div><div class="pressure-value" style="color:#e0e0e0">${rb.total_delta>0?'+':''}${rb.total_delta}</div></div>`;
    if (ge.spread) pressureItems += `<div class="pressure-item"><div class="pressure-label">SPREAD</div><div class="pressure-value" style="color:#e0e0e0">${ge.spread}</div></div>`;
    if (ge.environment) pressureItems += `<div class="pressure-item"><div class="pressure-label">GAME ENV</div><div style="font-size:13px;font-weight:700;color:${ge.environment==='BLOWOUT_LIKELY'?'#ff4757':ge.environment==='COMFORTABLE'?'#4ecdc4':'#ffd700'}">${ge.environment}</div></div>`;
    if (ge.blowout_prob!=null) pressureItems += `<div class="pressure-item"><div class="pressure-label">BLOWOUT %</div><div class="pressure-value" style="color:${ge.blowout_prob>0.4?'#ff4757':'#4ecdc4'}">${(ge.blowout_prob*100).toFixed(0)}%</div></div>`;
    if (formCode) pressureItems += `<div class="pressure-item"><div class="pressure-label">FORM</div><div style="font-size:13px;font-weight:700;color:${formCode.includes('HOT')?'#00ff87':formCode.includes('COLD')?'#ff4757':'#ffd700'}">${formCode}</div></div>`;
    if (rf.cv!=null) pressureItems += `<div class="pressure-item"><div class="pressure-label">CV (STREAK)</div><div class="pressure-value" style="color:#e0e0e0">${rf.cv.toFixed(3)}</div></div>`;
    if (pressureItems) html += `<div class="card"><div class="section-label">Game Pressure</div><div class="pressure-row">${pressureItems}</div></div>`;

    // STORY TIMELINE
    if (beats.length > 0) {
      let beatsHtml = '';
      beats.forEach(b => {
        const color = beatC(b.beat_type);
        const facts = b.facts || {};
        let detail = '';
        if (b.beat_type === 'LINEUP_CHANGE') detail = `${facts.player_name||'?'} → ${facts.change_type||'?'}`;
        else if (b.beat_type === 'LINE_MOVE') detail = `${facts.snapshot_type||'?'}: ${facts.previous_value||'?'} → ${facts.value||'?'} (${facts.delta>0?'+':''}${facts.delta||0})`;
        beatsHtml += `<div class="beat"><div class="beat-dot" style="background:${color}"></div><span class="beat-type" style="color:${color}">${b.beat_type}</span><span class="beat-detail">${detail}</span></div>`;
      });
      html += `<div class="card"><div class="section-label">Signal Story</div>${loom.headline?`<div style="font-size:12px;color:#e0e0e0;margin-bottom:10px;font-style:italic">"${loom.headline}"</div>`:''}
      <div class="timeline"><div class="timeline-line"></div>${beatsHtml}</div></div>`;
    }

    // LINE MOVEMENT + PLATFORMS
    const curPlats = (plat.platforms) || {};
    const hasBirthPlats = Object.keys(birthPlats).length > 0;
    const hasCurPlats = Object.keys(curPlats).length > 0;

    let allLines = [];
    if (hasCurPlats) allLines.push(...Object.values(curPlats));
    if (hasBirthPlats) {
      Object.values(birthPlats).forEach(v => {
        if (typeof v === 'object' && v !== null) allLines.push(v.line);
        else if (typeof v === 'number') allLines.push(v);
      });
    }
    const barMin = allLines.length ? Math.min(...allLines) * 0.9 : 0;
    const barMax = allLines.length ? Math.max(...allLines) * 1.05 : 1;

    let realBirthDelta = mot.birth_delta || 0;
    if (hasBirthPlats && hasCurPlats) {
      let totalDelta = 0; let count = 0;
      Object.keys(curPlats).forEach(book => {
        const curVal = curPlats[book];
        let birthVal = null;
        if (birthPlats[book] !== undefined) {
          birthVal = typeof birthPlats[book] === 'object' ? birthPlats[book].line : birthPlats[book];
        }
        if (birthVal !== null && birthVal !== undefined) {
          totalDelta += (curVal - birthVal);
          count++;
        }
      });
      if (count > 0) realBirthDelta = totalDelta / count;
    }

    const displayBirth = mot.birth_line || line;
    const displayCurrent = mot.current_line || line;
    const displayDelta = realBirthDelta !== 0 ? realBirthDelta : (mot.birth_delta || 0);

    html += `<div class="card"><div class="section-label">Line Movement</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><span style="color:#888;font-size:12px">Birth: </span><span class="mono" style="font-size:17px;font-weight:700;color:#e0e0e0">${displayBirth}</span></div>
        <div style="color:${displayDelta>0?'#00ff87':displayDelta<0?'#ff4757':'#888'};font-size:18px;font-weight:700">→ ${displayDelta>0?'+':''}${displayDelta.toFixed(1)}</div>
        <div><span style="color:#888;font-size:12px">Now: </span><span class="mono" style="font-size:17px;font-weight:700;color:#fff">${displayCurrent}</span></div>
      </div>`;

    const platformChanges = (bc.platform_line_changes) || {};
    if (hasCurPlats) {
      const books = Object.keys(curPlats).sort((a,b) => curPlats[b] - curPlats[a]);
      books.forEach(book => {
        const curVal = curPlats[book];
        let birthVal = null;
        if (birthPlats[book] !== undefined) {
          birthVal = typeof birthPlats[book] === 'object' ? birthPlats[book].line : birthPlats[book];
        }
        const bookDelta = birthVal !== null && birthVal !== undefined ? curVal - birthVal : null;
        const pColor = curVal > (plat.consensus_line||line) ? '#ff6b6b' : curVal === (plat.consensus_line||line) ? '#ffd700' : '#4ecdc4';
        const barWidth = ((curVal - barMin) / (barMax - barMin)) * 100;

        let deltaStr = '';
        if (bookDelta !== null && bookDelta !== 0) {
          const dColor = bookDelta > 0 ? '#00ff87' : '#ff4757';
          deltaStr = `<span class="mono" style="color:${dColor};font-size:10px;margin-left:6px">${bookDelta>0?'+':''}${bookDelta.toFixed(1)}</span>`;
        } else if (birthVal === null || birthVal === undefined) {
          deltaStr = `<span style="color:#3498db;font-size:10px;margin-left:6px">NEW</span>`;
        }

        let birthStr = '';
        if (birthVal !== null && birthVal !== undefined) {
          birthStr = `<span class="platform-birth">${birthVal}</span><span class="platform-arrow">→</span>`;
        }

        let changesStr = '';
        const bookChanges = platformChanges[book] || platformChanges[book.toLowerCase()] || [];
        if (bookChanges.length > 0) {
          const steps = bookChanges.map(ch => {
            const chColor = ch.change_from !== undefined ? (ch.line > ch.change_from ? '#00ff87' : '#ff4757') : '#888';
            return `<span style="color:${chColor}">${ch.line}</span>`;
          });
          changesStr = `<span class="platform-changes">[${steps.join(' → ')}]</span>`;
        }

        html += `<div class="platform-row">
          <span class="platform-name">${book.toUpperCase()}</span>
          <div class="platform-track">
            <div class="platform-fill" style="width:${barWidth}%;background:linear-gradient(90deg,${pColor}88,${pColor})"></div>
          </div>
          ${birthStr}
          <span class="platform-val">${curVal}</span>
          ${deltaStr}
          ${changesStr}
        </div>`;
      });
    }
    html += `</div>`;

    // MODULE BREAKDOWN (vs current line)
    html += `<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="section-label" style="margin-bottom:0">Module Breakdown</div>
      <div style="font-size:12px"><span style="color:#00ff87;font-weight:700">${overCount} OVER</span><span style="color:#555;margin:0 5px">|</span><span style="color:#ff4757;font-weight:700">${underCount} UNDER</span></div>
    </div>`;
    modDeltas.forEach(m => {
      const delta = m.value - m.line;
      const dir = delta > 0 ? 'OVER' : delta < 0 ? 'UNDER' : 'PUSH';
      const dColor = dir==='OVER'?'#00ff87':dir==='UNDER'?'#ff4757':'#a0a0a0';
      html += `<div class="simple-row"><span class="simple-label">${m.label}</span><span class="simple-val">${typeof m.value==='number'?m.value.toFixed(1):m.value}</span><span class="simple-delta" style="color:${dColor}">${delta>0?'+':''}${delta.toFixed(1)} ${dir}</span></div>`;
    });

    let ctxHtml = '';
    if (modules.REST && modules.REST.is_b2b) ctxHtml += `<span class="ctx-pill" style="background:#ff475722;color:#ff4757">B2B</span>`;
    if (modules.REST && !modules.REST.is_b2b && modules.REST.days_rest > 1) ctxHtml += `<span class="ctx-pill" style="background:#00ff8722;color:#00ff87">REST: ${modules.REST.days_rest}d</span>`;
    if (modules.DEFENSE) ctxHtml += `<span class="ctx-pill" style="background:${modules.DEFENSE.tier==='POOR'||modules.DEFENSE.tier==='WEAK'?'#00ff8722':'#55555522'};color:${modules.DEFENSE.tier==='POOR'||modules.DEFENSE.tier==='WEAK'?'#00ff87':'#888'}">DEF: ${modules.DEFENSE.tier} (#${modules.DEFENSE.defense_rank})</span>`;
    if (ge.environment) ctxHtml += `<span class="ctx-pill" style="background:#ffd70022;color:#ffd700">${ge.environment} (${(ge.blowout_prob*100).toFixed(0)}%)</span>`;
    if (ge.player_role) ctxHtml += `<span class="ctx-pill" style="background:#55555522;color:#888">ROLE: ${ge.player_role}</span>`;
    if (ctxHtml) html += `<div class="ctx-pills">${ctxHtml}</div>`;
    html += `</div>`;

    // ── LINE RECALIBRATOR INPUT (always shown) ──
    const inputVal = recalLine !== null ? recalLine : '';
    html += `<div class="recal-card" style="${recalLine ? 'margin-bottom:0;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:none' : ''}">
      <div class="recal-header">
        <div class="recal-title">⚗ Line Recalibrator</div>
        <span style="font-size:10px;color:#555">recalc modules vs new line</span>
      </div>
      <div style="font-size:12px;color:#555;margin-bottom:10px">
        Birth line: <span class="mono" style="color:#888">${birthLine}</span>
        &nbsp;·&nbsp; Current line: <span class="mono" style="color:#e0e0e0">${currentLine}</span>
        &nbsp;·&nbsp; ${recalStats.length} modules available
      </div>
      <div class="recal-input-row">
        <input
          id="recalInput"
          class="recal-input"
          type="number"
          step="0.5"
          min="0"
          placeholder="${currentLine}"
          value="${inputVal}"
          onkeydown="if(event.key==='Enter') applyRecal()"
        />
        <button class="recal-btn" onclick="applyRecal()">RECALCULATE</button>
        <span class="recal-birth-ref">Birth @ ${birthLine}</span>
      </div>
    </div>`;

    // ── RECALIBRATOR RESULTS (shown only when recalLine is set) ──
    if (recalLine !== null && recalStats.length > 0) {
      html += renderRecalibrator(d, birthLine, currentLine, recalStats);
    }

    // NET DELTA GAUGE
    if (netDelta !== null) {
      const ndColor = netDelta > 0 ? '#00ff87' : netDelta < 0 ? '#ff4757' : '#888';
      const ndDir = netDelta > 0 ? 'OVER' : netDelta < 0 ? 'UNDER' : 'NEUTRAL';
      const mismatch = projDir && ndDir !== projDir && ndDir !== 'NEUTRAL';
      html += `<div class="net-gauge" style="background:${mismatch?'linear-gradient(135deg,#12121a,#2a1a1a)':'linear-gradient(135deg,#12121a,#1a1a2e)'};border:2px solid ${mismatch?'#ff6b6b66':ndColor+'44'}">
        <div class="section-label">Net Delta</div>
        <div class="net-value" style="color:${ndColor}">${netDelta>0?'+':''}${netDelta.toFixed(4)}</div>
        <div class="net-dir" style="color:${ndColor}">${ndDir}</div>
        ${mismatch?`<div class="mismatch"><span>⚠ MISMATCH — Net Delta says ${ndDir} but Projection says ${projDir}</span></div>`:''}
        <div class="net-stats">
          <div><div class="net-stat-label">WEIGHTED</div><div class="net-stat-val">${weightedDelta>0?'+':''}${weightedDelta.toFixed(4)}</div></div>
          <div><div class="net-stat-label">MODULES</div><div class="net-stat-val">${agg.non_zero_modules||0}/15</div></div>
          <div><div class="net-stat-label">AVG RELIABILITY</div><div class="net-stat-val">${((agg.avg_reliability||0)*100).toFixed(1)}%</div></div>
        </div>
      </div>`;
    }

    // MODULE DELTA BARS
    if (urdrMods.length > 0) {
      html += `<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="section-label" style="margin-bottom:0">Module Delta Logit (OVER ←→ UNDER)</div>
        <div style="font-size:10px;color:#555">reliability →</div>
      </div>`;
      const maxD = 0.6;
      activeMods.forEach(m => {
        const dd = m.delta_logit_over;
        const pct = Math.min(Math.abs(dd)/maxD,1)*100;
        const isOver = dd > 0;
        const color = isOver ? '#00ff87' : '#ff4757';
        const relColor = m.reliability > 0.7 ? '#4ecdc4' : m.reliability > 0.4 ? '#ffd700' : '#555';
        const fillStyle = isOver ? `left:50%;width:${pct/2}%` : `right:50%;width:${pct/2}%`;
        html += `<div class="mod-row">
          <span class="mod-name">${(m.code||'').replace(/_/g,' ')}</span>
          <div class="mod-track"><div class="mod-center"></div><div class="mod-fill" style="${fillStyle};background:${color}aa"></div></div>
          <span class="mod-val" style="color:${color}">${dd>0?'+':''}${dd.toFixed(4)}</span>
          <span class="mod-rel" style="color:${relColor}">${(m.reliability*100).toFixed(0)}%</span>
        </div>`;
      });
      if (zeroMods.length > 0) {
        html += `<div class="zero-mods">ZERO IMPACT: ${zeroMods.map(m=>(m.code||'').replace(/_/g,' ')).join(', ')}</div>`;
      }
      html += `</div>`;
    }

    // QUALITY GATES
    if (qual.gate_a || qual.gate_b || qual.gate_c) {
      html += `<div class="card"><div class="section-label">Quality Gates</div>`;
      [qual.gate_a, qual.gate_b, qual.gate_c].filter(Boolean).forEach(g => {
        const dotColor = g.passed === true ? '#00ff87' : g.passed === false ? '#ff4757' : '#ffd700';
        let info = '';
        if (g.edge_pct) info += `<span class="gate-info" style="color:#00ff87">${g.edge_pct}%</span>`;
        if (g.confidence) info += `<span class="gate-info" style="color:#ffd700;margin-left:6px">${g.confidence}</span>`;
        if (g.trap_codes) info += g.trap_codes.map(t=>`<span class="gate-info" style="color:#ff4757;margin-left:6px">${t}</span>`).join('');
        html += `<div class="gate-row"><div class="gate-dot" style="background:${dotColor}"></div><span class="gate-name">${g.gate||'?'}</span>${info}</div>`;
      });
      html += `</div>`;
    }

    // LATTICE
    if (Object.keys(lat).length > 0) {
      html += `<div class="card"><div class="section-label">Lattice</div><div class="lattice-row">`;
      Object.entries(lat).forEach(([k,v]) => {
        html += `<div class="lattice-item"><div class="lattice-key">${k}</div><div class="lattice-val">${v===null?'—':v}</div></div>`;
      });
      html += `</div></div>`;
    }

    // VERDICT
    html += `<div class="verdict" style="border:2px solid ${dirColor}44">
      <div class="section-label" style="letter-spacing:2px">COLD READ SUMMARY</div>
      <div style="font-size:13px;color:#888">
        Modules: <strong style="color:#00ff87">${overCount}</strong> OVER / <strong style="color:#ff4757">${underCount}</strong> UNDER vs line ${line}
      </div>
      <div style="font-size:13px;color:#888;margin-top:4px">
        Net Delta: <strong class="mono" style="color:${netDelta>0?'#00ff87':netDelta<0?'#ff4757':'#888'}">${netDelta!==null?(netDelta>0?'+':'')+netDelta.toFixed(4):'—'}</strong>
         · Weighted: <strong class="mono" style="color:${weightedDelta>0?'#00ff87':weightedDelta<0?'#ff4757':'#888'}">${weightedDelta>0?'+':''}${weightedDelta.toFixed(4)}</strong>
      </div>
    </div>`;

    // RAW JSON
    if (showRaw) {
      html += `<div class="card"><div class="section-label">Raw JSON</div><pre style="color:#888;font-size:10px;overflow:auto;max-height:400px;font-family:'JetBrains Mono',monospace;white-space:pre-wrap;word-break:break-all">${JSON.stringify(currentCard,null,2)}</pre></div>`;
    }

    document.getElementById('dashboard').innerHTML = html;
  } catch(e) {
    document.getElementById('dashboard').innerHTML = '<div style="color:#ff4757;padding:20px">Render error: '+e.message+'</div>';
    console.error(e);
  }
}

// Init
loadSample();
</script>
</body>
</html>
